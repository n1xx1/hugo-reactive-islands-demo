{{- $batch := js.Batch "js/bundle" -}}

{{- $rendererId := xxhash .rendererPath -}}
{{- $rendererResource := resources.FromString
  (printf "%s_resource.js" $rendererId)
  (printf `export * from "%[1]s"; export { default } from "%[1]s"; export const __hugo_runner = true;` .rendererPath)
-}}
{{- with $batch.Group $rendererId -}}
  {{- with .Runner "_" -}}
    {{- .SetOptions (dict "resource" $rendererResource "export" "__hugo_runner") -}}
  {{- end -}}
{{- end -}}

{{- $componentId := xxhash .componentPath -}}
{{- $componentResource := resources.FromString
  (printf "%s_resource.js" $componentId)
  (printf `export * from "%[1]s"; export { default } from "%[1]s"; export const __hugo_runner = true;` .componentPath)
-}}
{{- with $batch.Group $componentId -}}
  {{- with .Runner "_" -}}
    {{- .SetOptions (dict "resource" $componentResource "export" "__hugo_runner") -}}
  {{- end -}}
{{- end -}}

{{- $uid := xxhash (printf "%s-%s-%d" $rendererId $componentId math.Counter) -}}
{{- $jsonProps := .props | jsonify -}}

{{- $renderedContentCode := printf `
  import { renderToStaticMarkup } from "%[1]s";
  import * as componentModule from "%[2]s";
  export default function() {
  return renderToStaticMarkup({
  Component: componentModule[%[4]s],
  props: %[3]s,
  children: %[6]s,
  context: %[5]s,
  });
  }`
  .serverRendererPath
  .componentPath
  $jsonProps
  ("default" | jsonify)
  (dict "uid" $uid | jsonify)
  (.inner | jsonify)
-}}
{{- $renderedResult := partial "utils/execJs" $renderedContentCode -}}

{{- $renderedAttrs := printf ` %s="%s"` "props" (htmlEscape $jsonProps) -}}
{{- range $k, $v := $renderedResult.attrs -}}
  {{- $renderedAttrs = add $renderedAttrs (printf ` %s="%s"` $k (htmlEscape $v)) -}}
{{- end -}}

{{- $deferKey := printf "%s-%d" (anchorize .context.Path) math.Counter -}}
{{- $deferData := dict
  "rendererId" $rendererId
  "componentId" $componentId
  "renderedContent" $renderedResult.html
  "renderedAttrs" $renderedAttrs
-}}

{{- with (templates.Defer (dict "key" $deferKey "data" $deferData)) -}}
  {{- $rendererUrl := "" -}}
  {{- $componentUrl := "" -}}

  {{- $data := . -}}
  {{- $batch := js.Batch "js/bundle" -}}
  {{- with $batch.Build -}}
    {{- range index .Groups $data.rendererId -}}
      {{- if hasSuffix .Name "_runner.js" -}}
        {{- $rendererUrl = .RelPermalink -}}
      {{- end -}}
    {{- end -}}
    {{- range index .Groups $data.componentId -}}
      {{- if hasSuffix .Name "_runner.js" -}}
        {{- $componentUrl = .RelPermalink -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}


  <hugo-island
    renderer-url="{{ $rendererUrl }}"
    component-url="{{ $componentUrl }}"
    {{ .renderedAttrs | safeHTMLAttr }}
  >
    {{- .renderedContent | safeHTML -}}
  </hugo-island>
{{- end -}}
